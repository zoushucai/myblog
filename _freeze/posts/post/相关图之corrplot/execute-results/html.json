{
  "hash": "1141b5dc71f5c13d6c4cb35c49157b7b",
  "result": {
    "markdown": "---\ntitle: 相关图之corrplot\ndate: '2018-07-15'\ncategories: r\n---\n\n\n\n\n\n\n## 相关矩阵图二-----corrplot\n\n### `corrplot::corrplot()`函数\n\n由于`corrgram::corrgram()`函数没有显示相关性的大小度量关系，于是经常用`corrplot::corrplot()`函数来画相关矩阵图，不过此图的缺点是`title`画出来不好看\n\n```R\ncorrplot(corr, \n  method = c(\"circle\", \"square\", \"ellipse\", \"number\", \"shade\",\"color\", \"pie\"), \n  type = c(\"full\", \"lower\", \"upper\"), add = FALSE,\n  col = NULL, bg = \"white\", title = \"\", is.corr = TRUE, diag = TRUE,\n  outline = FALSE, mar = c(0, 0, 0, 0), addgrid.col = NULL,\n  addCoef.col = NULL, addCoefasPercent = FALSE, order = c(\"original\",\n  \"AOE\", \"FPC\", \"hclust\", \"alphabet\"), hclust.method = c(\"complete\", \"ward\",\n  \"ward.D\", \"ward.D2\", \"single\", \"average\", \"mcquitty\", \"median\", \"centroid\"),\n  addrect = NULL, rect.col = \"black\", rect.lwd = 2, tl.pos = NULL,\n  tl.cex = 1, tl.col = \"red\", tl.offset = 0.4, tl.srt = 90,\n  cl.pos = NULL, cl.lim = NULL, cl.length = NULL, cl.cex = 0.8,\n  cl.ratio = 0.15, cl.align.text = \"c\", cl.offset = 0.5, number.cex = 1,\n  number.font = 2, number.digits = NULL, addshade = c(\"negative\",\n  \"positive\", \"all\"), shade.lwd = 1, shade.col = \"white\", p.mat = NULL,\n  sig.level = 0.05, insig = c(\"pch\", \"p-value\", \"blank\", \"n\", \"label_sig\"),\n  pch = 4, pch.col = \"black\", pch.cex = 3, plotCI = c(\"n\", \"square\",\n  \"circle\", \"rect\"), lowCI.mat = NULL, uppCI.mat = NULL, na.label = \"?\",\n  na.label.col = \"black\", win.asp = 1, ...)\n\n\n参数解释：\ncorr： 用于绘图的矩阵，必须是正方形矩阵(即相关系数矩阵)，如果是普通的矩阵，需要设置is.corr=FALSE \nmethod：可以是circle(圆形,默认),square(方形),ellipse(椭圆形),number(数值),shade(阴影),color(颜色),pie(饼图)。\ntype：用于设置相关矩阵图的显示区域：full(全部，默认), lower(下三角), upper(上三角)。\ncol：指定图形展示的颜色，默认以均匀的颜色展示，可以通过colorRampPalette函数向col参数赋值来设置颜色。\nbg：指定图的背景色 \ntitle：为图形添加标题\ndiag：是否展示对角线上的结果，默认为TRUE\noutline：是否绘制圆形、方形或椭圆形的轮廓，默认为FALSE\nmar：具体设置图形的四边间距\naddgrid.col：当选择的方法为颜色或阴影时，默认的网格线颜色为白色，否则为灰色\naddCoef.col：为相关系数添加颜色，默认不添加相关系数，只有方法为number时，该参数才起作用\naddCoefasPercent：为节省绘图空间，是否将相关系数转换为百分比格式，默认为FALSE\norder：指定相关系数排序的方法，一般”AOE”排序结果都比”FPC”要好\n        可以是：original(原始顺序)、AOE(特征向量角序)、FPC(第一主成分顺序)、hclust(层次聚类顺序)和alphabet(字母顺序)\n        \nhclust.method：当order为hclust时，该参数可以是层次聚类中ward法、最大距离法等7种之一\naddrect：当order为hclust时，可以为添加相关系数图添加矩形框，默认不添加框，如果想添加框时，只需为该参数指定一个整数即可\nrect.col：指定矩形框的颜色\nrect.lwd：指定矩形框的线宽\ntl.pos：指定文本标签(变量名称)的位置，字符型参数为：\"lt\", \"ld\", \"td\", \"d\" or \"n\"\n\t  当type=full时，默认标签位置在左边和顶部(lt)，\n  \t当type=lower时，默认标签在左边和对角线(ld)，\n\t  当type=upper时，默认标签在顶部和对角线， d表示diagonal(对角线)， n表示不添加文本标签\n\ntl.cex：指定文本标签的大小\ntl.col：指定文本标签的颜色\ncl.pos：图例（颜色条）位置，\n\t  当type=upper或full时，图例在右表(r)，\n\t  当type=lower时，图例在底部，\n\t  不需要图例时，只需指定该参数为n\n\naddshade：只有当method=shade时，该参数才有用，\n    参数值可以是negtive/positive和all，分表表示对负相关系数、正相关系数和所有相关系数添加阴影。\n    注意：正相关系数的阴影是45度，负相关系数的阴影是135度\n\nshade.lwd：指定阴影的线宽\nshade.col：指定阴影线的颜色\n\n参数 cl.*  用于设置图例的颜色（图例的色条），tl.* 用于设置图例的文本(标量名称)。\n对于文本标签，这两个函数 tl.col（文本标签颜色）和tl.srt（文本标签字符串旋转）用于更改文本颜色和旋转。\n```\n\n\n\n#### 使用不同的method绘制相关矩阵图\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(corrplot)\n\nM <- cor(mtcars)\nmethod = c(\"circle\", \"square\", \"ellipse\", \"number\", \"shade\",\"color\")\npar(mfrow=c(3,2))\nt = mapply(function(x){corrplot(M,method = x,order = \"AOE\",title=paste0(\"method=\",x))},method)\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n#### 设置布局类型（参数type）：  \ntype = c(\"full\", \"lower\", \"upper\")   \ncorrplot.mixed() 是一个混合可视化风格的包装函数。  \n\n::: {.cell}\n\n```{.r .cell-code}\nM <- cor(mtcars)\ntype = c(\"full\", \"lower\", \"upper\")\npar(mfrow=c(1,3))\nt = mapply(function(x){corrplot(M,order = \"hclust\",type = x,title=paste0(\"type=\",x))},type)\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(2,2))\ncorrplot.mixed(M)\ncorrplot.mixed(M, lower.col = \"black\", number.cex = .7)\ncorrplot.mixed(M, lower = \"ellipse\", upper = \"circle\")\ncorrplot.mixed(M, lower = \"square\", upper = \"circle\", tl.col = \"black\") # tl.col：指定文本标签的颜色\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n#### 相关矩阵重排序\n\n\n::: {.cell}\n\n```{.r .cell-code}\norder = c(\"original\",\"AOE\", \"FPC\", \"hclust\", \"alphabet\")\npar(mfrow=c(2,3))\nt = mapply(function(x){corrplot(M,order = x,title=paste0(\"order=\",x))},order)\n\n\n####### # 如果使用\"hclust\"，corrplot()可以根据层次聚类的结果在corrrlation矩阵图表周围绘制矩形。\npar(mfrow=c(1,2))\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\ncorrplot(M, order = \"hclust\", addrect = 2)\ncorrplot(M, order = \"hclust\", addrect = 3)\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n\n```{.r .cell-code}\n####### # 改变背景颜色以及图像颜色\npar(mfrow=c(1,1))\ncorrplot(M, type = \"upper\", order = \"hclust\", col = c(\"black\", \"white\"), bg = \"lightblue\")\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-4-3.png){width=672}\n:::\n:::\n\n\n#### 使用不同的色谱\n\n::: {.cell}\n\n```{.r .cell-code}\n# 如上一节所示，可以定制相关图的颜色。该功能colorRampPalette()非常便于产生色谱。\n\ncol1 <- colorRampPalette(c(\"#7F0000\", \"red\", \"#FF7F00\", \"yellow\", \"white\",\n                           \"cyan\", \"#007FFF\", \"blue\", \"#00007F\"))\ncol2 <- colorRampPalette(c(\"#67001F\", \"#B2182B\", \"#D6604D\", \"#F4A582\",\n                           \"#FDDBC7\", \"#FFFFFF\", \"#D1E5F0\", \"#92C5DE\",\n                           \"#4393C3\", \"#2166AC\", \"#053061\"))\ncol3 <- colorRampPalette(c(\"red\", \"white\", \"blue\")) \ncol4 <- colorRampPalette(c(\"#7F0000\", \"red\", \"#FF7F00\", \"yellow\", \"#7FFF7F\",\n                           \"cyan\", \"#007FFF\", \"blue\", \"#00007F\"))\nwhiteblack <- c(\"white\", \"black\")\n\n## using these color spectra\npar(mfrow=c(2,2))\ncorrplot(M, order = \"hclust\", addrect = 2, col = col1(100))\ncorrplot(M, order = \"hclust\", addrect = 2, col = col2(50))\ncorrplot(M, order = \"hclust\", addrect = 2, col = col3(20))\ncorrplot(M, order = \"hclust\", addrect = 2, col = col4(10))\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\n\n\npar(mfrow=c(1,1))\ncorrplot(M, order = \"hclust\", addrect = 2, col = whiteblack, bg = \"gold2\")\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n\n```{.r .cell-code}\n\n\n### 使用调色板包\n# 您也可以使用标准调色板（包grDevices）\npar(mfrow=c(2,2))\ncorrplot(M, order = \"hclust\", addrect = 2, col = heat.colors(100))\ncorrplot(M, order = \"hclust\", addrect = 2, col = terrain.colors(100))\ncorrplot(M, order = \"hclust\", addrect = 2, col = cm.colors(100))\ncorrplot(M, order = \"hclust\", addrect = 2, col = gray.colors(100))\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-5-3.png){width=672}\n:::\n\n```{.r .cell-code}\n\n\n### 使用调色板包---使用RcolorBrewer包。\n\nlibrary(RColorBrewer)\ncorrplot(M, type = \"upper\", order = \"hclust\",col = brewer.pal(n = 8, name = \"RdBu\"))\ncorrplot(M, type = \"upper\", order = \"hclust\",col = brewer.pal(n = 8, name = \"RdYlBu\"))\ncorrplot(M, type = \"upper\", order = \"hclust\",col = brewer.pal(n = 8, name = \"PuOr\"))\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-5-4.png){width=672}\n:::\n:::\n\n\n#### 更改文本标签和图例的颜色和旋转\n\n参数 `cl.*` 用于设置图例的颜色，`tl.* ` 用于设置图例的文本。\n\n对于文本标签，这两个函数` tl.col`（文本标签颜色）和`tl.srt`（文本标签字符串旋转）用于更改文本颜色和旋转。\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(2,2))\n\n## remove color legend and text legend 移除图例的颜色部分和文字标签部分\ncorrplot(M, order = \"AOE\", cl.pos = \"n\", tl.pos = \"n\")  \n\n## bottom  color legend, diagonal text legend, rotate text label\n## 图底图例，对角线文字图例，旋转文字标签\ncorrplot(M, order = \"AOE\", cl.pos = \"b\", tl.pos = \"d\", tl.srt = 60) \n\n## a wider color legend with numbers right aligned\ncorrplot(M, order = \"AOE\", cl.ratio = 0.2, cl.align = \"r\")\n\n## text labels rotated 45 degrees\ncorrplot(M, type = \"lower\", order = \"hclust\", tl.col = \"black\", tl.srt = 45)\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n#### 处理非相关矩阵\n\n\n::: {.cell}\n\n```{.r .cell-code}\n\npar(mfrow=c(2,2))\ncorrplot(abs(M),order = \"AOE\", col = col3(200), cl.lim = c(0, 1))\n\n## visualize a  matrix in [-100, 100]\nran <- round(matrix(runif(225, -100,100), 15))\ncorrplot(ran, is.corr = FALSE, method = \"square\")\n\n## a beautiful color legend \ncorrplot(ran, is.corr = FALSE, method = \"ellipse\", cl.lim = c(-100, 100))\n\n#如果矩阵是矩形，则可以使用win.asp参数调整纵横比， 以使矩阵呈现为正方形。\nran <- matrix(rnorm(70), ncol = 7)\ncorrplot(ran, is.corr = FALSE, win.asp = .7, method = \"circle\")\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n#### 处理缺失（NA）值\n\n默认情况下，corrplot将NA值呈现为\"?\"字符。使用na.label 参数，可以使用不同的值（最多支持两个字符）。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nM2 <- M\ndiag(M2) = NA\ncorrplot(M2)\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\npar(mfrow=c(1,2))\ncorrplot(M2, na.label = \"o\")\ncorrplot(M2, na.label = \"NA\")\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n:::\n\n\n#### 在标签中使用`\"plotmath\"`表达式\n\n从版本开始0.78，可以 在变量名中使用` plotmath`表达式。要激活`plotmath`渲染，请在标签前加上一个字符`\":\"，\"=\"`or `\"$\"`。\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nM2 <- M[1:5,1:5]\ncolnames(M2) <- c(\"alpha\", \"beta\", \":alpha+beta\", \":a[0]\", \"=a[beta]\")\nrownames(M2) <- c(\"alpha\", \"beta\", NA, \"$a[0]\", \"$ a[beta]\")\ncorrplot(M2)\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n#### 将相关图与显着性检验相结合\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres1 <- cor.mtest(mtcars, conf.level = .95)\nres2 <- cor.mtest(mtcars, conf.level = .99)\npar(mfrow=c(1,3))\n## specialized the insignificant value according to the significant level\ncorrplot(M, p.mat = res1$p, sig.level = .2)\n\ncorrplot(M, p.mat = res1$p, sig.level = .05)\n\ncorrplot(M, p.mat = res1$p, sig.level = .01)\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n```{.r .cell-code}\n\n\n\n## leave blank on no significant coefficient\ncorrplot(M, p.mat = res1$p, insig = \"blank\")\n\n## add p-values on no significant coefficient\ncorrplot(M, p.mat = res1$p, insig = \"p-value\")\n\n## add all p-values\ncorrplot(M, p.mat = res1$p, insig = \"p-value\", sig.level = -1)\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-10-2.png){width=672}\n:::\n\n```{.r .cell-code}\n\n\n\n## add cross on no significant coefficient \npar(mfrow=c(1,1))\ncorrplot(M, p.mat = res1$p, order = \"hclust\", insig = \"pch\", addrect = 3)\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-10-3.png){width=672}\n:::\n:::\n\n\n#### 可视化置信区间\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(3,2))\ncorrplot(M, low = res1$lowCI, upp = res1$uppCI, order = \"hclust\",\n         rect.col = \"navy\", plotC = \"rect\", cl.pos = \"n\")\n\n\n\ncorrplot(M, p.mat = res1$p, low = res1$lowCI, upp = res1$uppCI,\n         order = \"hclust\", pch.col = \"red\", sig.level = 0.01,\n         addrect = 3, rect.col = \"navy\", plotC = \"rect\", cl.pos = \"n\")\n\n\n\n\nres1 <- cor.mtest(mtcars, conf.level = .95)\ncorrplot(M, p.mat = res1$p, insig = \"label_sig\",\n         sig.level = c(.001, .01, .05), pch.cex = .9, pch.col = \"white\")\n\n\n\ncorrplot(M, p.mat = res1$p, method = \"color\",\n         insig = \"label_sig\", pch.col = \"white\")\n\n\n\ncorrplot(M, p.mat = res1$p, method = \"color\", type = \"upper\",\n         sig.level = c(.001, .01, .05), pch.cex = .9,\n         insig = \"label_sig\", pch.col = \"white\", order = \"AOE\")\n\n\ncorrplot(M, p.mat = res1$p, insig = \"label_sig\", pch.col = \"white\",\n         pch = \"p<.05\", pch.cex = .5, order = \"AOE\")\n```\n\n::: {.cell-output-display}\n![](相关图之corrplot_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n#### 自定义相关图\n\n略\n\n\n\n参考： https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n#> R version 4.2.1 (2022-06-23)\n#> Platform: aarch64-apple-darwin20 (64-bit)\n#> Running under: macOS Monterey 12.5.1\n#> \n#> Matrix products: default\n#> BLAS:   /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRblas.0.dylib\n#> LAPACK: /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRlapack.dylib\n#> \n#> locale:\n#> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n#> \n#> attached base packages:\n#> [1] stats     graphics  grDevices utils     datasets  methods   base     \n#> \n#> other attached packages:\n#> [1] RColorBrewer_1.1-3 corrplot_0.92     \n#> \n#> loaded via a namespace (and not attached):\n#>  [1] digest_0.6.29     jsonlite_1.8.0    magrittr_2.0.3    evaluate_0.16    \n#>  [5] rlang_1.0.4       stringi_1.7.8     cli_3.3.0         rstudioapi_0.14  \n#>  [9] rmarkdown_2.16.1  tools_4.2.1       stringr_1.4.1     htmlwidgets_1.5.4\n#> [13] xfun_0.32         yaml_2.3.5        fastmap_1.1.0     compiler_4.2.1   \n#> [17] htmltools_0.5.3   knitr_1.40\n```\n:::\n",
    "supporting": [
      "相关图之corrplot_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}